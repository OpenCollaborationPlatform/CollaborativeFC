<!DOCTYPE html>
<html lang="en"> 
<html>
    <head>
        <meta charset="utf-8"/>
        <link rel="stylesheet" href="Resources/webix.css" type="text/css">
        <script src="Resources/webix.js" type="text/javascript"></script> 
        <script src="Resources/skin.js" type="text/javascript"></script>  
        <script src="https://cdn.auth0.com/w2/auth0-7.2.min.js"></script>
    </head>
    <body>
        <script type="text/javascript" charset="utf-8">
        
        var auth0 = new Auth0({
            domain:      'collaboration.eu.auth0.com',
            callbackURL: window.location.href,
            clientID:    'J5RTRMBYAehc061uZP1x9AEUcEkpb8mG',
            callbackOnLocationHash: true
        });
        
        function setProfile(profile, show) {
            $$("ProfilePicture").define('src', String(profile.picture));
            
            if ("username" in profile)
                $$("Username").setValue(profile.username);
            else if ("name" in profile)
                $$("Username").setValue(profile.name);
            else if ("nickname" in profile)
                $$("Username").setValue(profile.nickname);
            else
                $$("Username").setValue("Unknown");
            
            $$("EMail").setValue(profile.email);
            $$("body").setHTML(JSON.stringify(profile))
            if(show) {
                $$("info").show();
                backend.openConnection();
            }
            else
                $$("auth").show();
        };
               
        var pwLogin = function(id, e) {
            $$("ui").showProgress({type:"icon"});
            auth0.login(
              {
                connection: 'Username-Password-Authentication',
                username: $$("loginform").getValues()["user"],
                password: $$("loginform").getValues()["password"],
                sso: false
              },
              function (err, result) {
                  if (err) return webix.alert('Something went wrong: ' + err.message);
                  auth0.getProfile(result.idToken, function (err, profile) {
                      if (err) {
                          return webix.alert('error fetching profile: ' + JSON.stringify(err));
                      }
                      backend.saveLoginData(result.idToken, JSON.stringify(profile))
                      setProfile(profile, true)
                  });
                  $$("ui").hideProgress();
              }
            ); 
        };
        
        var githubLogin = function(id,e) {
            $$("ui").showProgress({type:"icon"});
            auth0.login(
                {connection: 'github'},
                function(err) {
                    if (err) webix.alert("something went wrong: " + err.message);
                    $$("ui").hideProgress();
                }
            );
        };
        
        var googleLogin = function(id,e) {
            $$("ui").showProgress({type:"icon"});
            auth0.login(
                {connection: 'google-oauth2'},
                function(err) {
                    if (err) webix.alert("something went wrong: " + err.message);
                    $$("ui").hideProgress();
                }
            );
         };
        
        var pwSignup = function(id, e) {
            auth0.signup(
              {
                connection: 'Username-Password-Authentication',
                username: $$("signupform").getValues()["user"],
                password: $$("signupform").getValues()["password1"],
                email: $$("signupform").getValues()["email"],
                auto_login: false
              }, 
              function (err) {
                  if (err) return webix.alert('Something went wrong: ' + err.message);
              }
            );
       };
        
        var login = {
            id: 'login',
            rows: [
              {},
              { view:'form',
                id: 'loginform',
                elements:[
                    { view:"text", name:"user", label:"Username"},
                    { view:"text", type:"password", name: "password", label:"Password"},
                    { type: "clean",
                      cols: [
                        { view:"button", 
                          label:"Login",
                          tooltip:"Login with username and password",
                          on:{'onItemClick': pwLogin} 
                        },
                        { view:"button",
                          type: "image",
                          image: "Resources/GitHub.png",
                          width: 60,
                          tooltip:"Login with your GitHub account",
                          on:{'onItemClick': githubLogin}
                        },
                        { view:"button",
                          type: "image",
                          image: "Resources/Google.jpg",
                          width: 60,
                          tooltip:"Login with your Google account",
                          on:{'onItemClick': googleLogin}
                        }
                      ]
                    }
                ]
              }
            ]
        };
        
        var logout = function() {
            //remove all login data and close the connection
            backend.clearLoginData()
            backend.closeConnection();
            
            //show the login screen
            $$("auth").show()
        };
        
        var signup = {
            id: 'signup',
            rows: [
              {},
              { view:'form',
                id:'signupform',
                elements:[
                    { view:"text", name: "email", type: "email", label:"Email"},
                    { view:"text", name: "user", label:"Username"},
                    { view:"text", name: "password1", type:"password", label:"Password"},
                    { view:"text", name: "password2", type:"password", label:"Repeat"},
                    { type: "clean",
                      cols: [
                        { view:"button", 
                          label:"Signup",
                          tooltip:"Signup with the filled-in form",
                          on:{'onItemClick': pwSignup} 
                        },
                        { view:"button",
                          type: "image",
                          image: "Resources/GitHub.png",
                          width: 60,
                          tooltip:"Signup with your GitHub account",
                          on:{'onItemClick': githubLogin}
                        },
                        { view:"button",
                          type: "image",
                          image: "Resources/Google.jpg",
                          width: 60,
                          tooltip:"Signup with your Google account",
                          on:{'onItemClick': googleLogin}
                        }
                      ]
                    }
                ]
              }
            ]
        };
        
        var auth = {
            id: 'auth',
            type: "clean",
            rows: [
              { type: "clean",
                cols: [
                  { },
                  { view: "template",
                    src: "Resources/logo.svg",
                    width: 245
                  },
                  {}
                ],
                height: 160
              },
              { view:"segmented",
                id:"navigation",
                options:[{id:"login", value: "Login"}, {id:"signup", value:"Signup"}],
                align:"center", 
                multiview:true,
                autoheight: true,
                optionWidth:120
              },
              { view: "multiview",
                id: "authviews",
                cells:[login, signup]
              },
            ]
        }
                 
        var info = {
            type: "line",
            id: "info",
            rows: [
                { cols: [
                    { id: "ProfilePicture",
                      template: "<img src:https://s.gravatar.com/avatar/4d58414f4b795d8697466fbd37303fbb?s=480&r=pg&d=https%3A%2F%2Fcdn.auth0.com%2Favatars%2Fne.png>",
                      width: 50,
                      height: 50
                    },
                    { rows: [
                        {  id: "Username",
                           view:"label",
                           label: "Text"
                        },
                        {  id: "EMail",
                           view:"label",
                           label: "Text"
                        }
                      ]
                    }
                  ]
                },
                { id: "body",
                  template: "not yet specified"                
                },
                { view:"button", 
                  value:"Logout",
                  on:{'onItemClick': logout} 
                }
            ]
        };
        
        var ui = {
            id: "ui",
            view: "multiview",
            cells:[auth, info]
        };
        
        webix.ui(ui);
        //adding progress bar functionality to it
        webix.extend($$("ui"), webix.ProgressBar);
               
        // callback redirect? Here we land with social login
        var result = auth0.parseHash(window.location.hash);
        if (result && result.idToken) {
            // This will execute on redirect callback
            auth0.getProfile(result.idToken, function(err, profile) {
              window.location.hash = "";
              if (err) {
                return webix.alert('error fetching profile: ' + JSON.stringify(err));
              }
              backend.saveLoginData(result.idToken, JSON.stringify(profile))
              setProfile(profile, true)
            });
        } else if (result && result.error) {
            webix.alert('Error at login: ' + result.error)
        }
               
        //check if we have a token and directly login if so
        token = backend.getValidToken()
        if(token) {
            //backend is responsible for checking if the token is valid!
            setProfile(JSON.parse(backend.getProfile()), true)   
        }
        
        </script>
    </body> 
</html>